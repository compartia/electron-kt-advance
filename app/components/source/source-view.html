<dom-module id="source-view">
    <template>

        <!-- source view [[file.relativePath]]
        data: [[lines]] -->

        <iron-list id="listOfLines" items="[[lines]]" selection-enabled on-selected-item-changed="_onLineSelected">
            <template>
                <div class="code-line">
                    <span class="info">[[index]]</span>
                    <span class$="[[_getClass(_loadedFile, index, lines)]]"></span>
                    <span class="info">[[_getPoNumber(_loadedFile, index, lines)]]</span>
                    <pre class="text">[[item.text]]</pre>
                </div>
            </template>
        </iron-list>

    </template>

    <script>
        Polymer({
            is: 'source-view',

            properties: {
                currentProject: Object,
                _loadedFile: String,

                file: {
                    type: Object,
                    notify: true
                },

                lines: {
                    type: String
                },

                statistics: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'filter-applied': '_onFilterApplied'
            },

            _getPoNumber: function(file, index, lines) {
                if (file) {
                    var stats = this.statistics.getStatsByFileLine(file.relativePath, index);
                    if (stats) {
                        return stats["sum"];
                    } else {
                        return "";
                    }

                } else {
                    return "-";
                }

            },

            _getClass: function(file, index, lines) {
                var clazz = "state-marker";
                if (file) {
                    var stats = this.statistics.getStatsByFileLine(file.relativePath, index);
                    if (stats) {
                        if (stats["VIOLATION"] > 0) {
                            clazz += " violation";
                        }

                        if (stats["OPEN"] > 0) {
                            clazz += " open";
                        }

                        if (stats["DISCHARGED"] > 0) {
                            clazz += " discharged";
                        }

                    }

                }
                return clazz;
            },

            // _hasViolations: function(file, index) {     if (file) {         var stats = this.statistics.getStatsByFileLine(file.relativePath, index);         if (stats) {             return stats["VIOLATION"] > 0;         } else {             return false;
            //   }
            //
            //     } else {         return false;     }
            //
            // },

            _onFilterApplied: function(event) {
                var newFile = event.detail.file;

                /**
                make sure it is called AFTER statistics is ready.
                **/
                if (newFile && !newFile.dir) {
                    if (this._loadedFile != newFile) {
                        this._loadedFile = newFile;
                        this.currentProject.loadFile(newFile.relativePath).then(function(fileContents) {

                            this.set("lines", fileContents.lines);

                        }.bind(this));
                    } else {
                        var lines = this.get("lines");
                        this.set("lines", []);
                        this.set("lines", lines);
                    }

                }
            }

        });
    </script>

</dom-module>
