<dom-module id="source-view">

    <template>

        <div id="scrollable">
            <iron-list scroll-target="scrollable" id="listOfLines" items="[[lines]]" max-physical-count="[[lines.length]]" selection-enabled on-selected-item-changed="_onLineSelected">
                <template>
                    <div class$="code-line [[_getClass(_loadedFile, index, statistics)]]">

                        <span class="info">
                            <span id="line-number">[[index]]</span>
                            <span class="state-marker"></span>
                            <span id="po-count">[[_getPoNumber(_loadedFile, index, statistics)]]</span>
                        </span>

                        <pre class="text">[[item.text]]</pre>

                    </div>
                </template>
            </iron-list>
        </div>

    </template>

    <script>
        Polymer({
            is: 'source-view',

            properties: {
                container: Object,
                currentProject: Object,
                _loadedFile: String,

                lines: {
                    type: String
                },

                statistics: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'filter-applied': '_onFilterApplied'
            },

            _getPoNumber: function(file, index, statistics) {
                if (file) {
                    var stats = statistics.getStatsByFileLine(file.relativePath, index);
                    if (stats) {
                        return stats["sum"];
                    } else {
                        return "";
                    }

                } else {
                    return "-";
                }

            },

            _getClass: function(file, index, statistics) {
                var clazz = "";
                if (file && statistics.getStatsByFileLine) {
                    var stats = statistics.getStatsByFileLine(file.relativePath, index);
                    if (stats) {
                        if (stats[kt.graph.PoStates[kt.graph.PoStates.violation]] > 0) {
                            clazz += " " + kt.graph.PoStates[kt.graph.PoStates.violation];
                        }

                        if (stats[kt.graph.PoStates[kt.graph.PoStates.open]] > 0) {
                            clazz += " " + kt.graph.PoStates[kt.graph.PoStates.open];
                        }

                        if (stats[kt.graph.PoStates[kt.graph.PoStates.discharged]] > 0) {
                            clazz += " " + kt.graph.PoStates[kt.graph.PoStates.discharged];
                        }

                    }

                }
                return clazz;
            },

            _onFilterApplied: function(event) {
                var newFile = event.detail.file;

                /**
                make sure it is called AFTER statistics is ready.
                **/
                if (newFile && !newFile.dir) {
                    if (this._loadedFile != newFile) {

                        this._loadedFile = newFile;
                        this.currentProject.loadFile(newFile.relativePath).then(function(fileContents) {
                            this.set("lines", fileContents.lines);
                        }.bind(this));

                    } else {

                        if (event.detail.cfunction) {
                            var task = function() {
                                this.$.listOfLines.scrollToIndex(event.detail.cfunction.line - 1);
                            }
                            setTimeout(task.bind(this));
                        }

                    }

                }
            }
        });
    </script>

</dom-module>
