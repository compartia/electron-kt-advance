<link rel="import" href="../common/node-decorator.html">

<dom-module id="source-view">

    <template>

        <div id="scrollable">
            <iron-list scroll-target="scrollable" id="listOfLines" items="[[lines]]" max-physical-count="[[lines.length]]" selection-enabled as="item">
                <template>
                    <div>
                        <div class$="code-line [[_getClass(_loadedFile, index, statistics, selected)]]">

                            <span class="info">
                                <span id="line-number">[[_lineNumber(index)]]</span>
                                <node-decorator show-count="true" statistics="[[_getStatsByLine(_loadedFile, index, statistics)]]"></node-decorator>
                            </span>


                            <pre class="text">[[item.text]]</pre>

                        </div>
                        <template is="dom-if" if="[[showAtLinePos(item, selected)]]">
                            <po-list filtered-proof-obligations="[[getPosAtLine(_loadedFile, index, statistics)]]"></po-list>
                        </template>
                    </div>

                </template>
            </iron-list>
        </div>

    </template>

    <script>
        Polymer({
            is: 'source-view',

            properties: {
                currentProject: Object,
                _loadedFile: Object,

                lines: {
                    type: String
                },

                statistics: {
                    type: Object,
                    notify: true
                }
            },

            showAtLinePos: function(item, selected){
                return selected ? true : false;
            },

            getPosAtLine: function(file, index, statistics) {
                return this.currentProject.getPosAtLine(file.relativePath, index + 1);
            },

            _getStatsByLine: function(file, index, statistics) {
                return statistics.getStatsByFileLine(file.relativePath, index);
            },

            _getClass: function(file, index, statistics, selected) {
                var clazz = "";
                if (file && statistics.getStatsByFileLine) {
                    var stats = statistics.getStatsByFileLine(file.relativePath, index);
                    if (stats) {
                        if (stats[kt.model.PoStates[kt.model.PoStates.violation]] > 0) {
                            clazz += " " + kt.model.PoStates[kt.model.PoStates.violation];
                        }

                        if (stats[kt.model.PoStates[kt.model.PoStates.open]] > 0) {
                            clazz += " " + kt.model.PoStates[kt.model.PoStates.open];
                        }

                        if (stats[kt.model.PoStates[kt.model.PoStates.discharged]] > 0) {
                            clazz += " " + kt.model.PoStates[kt.model.PoStates.discharged];
                        }

                    }

                }
                if(selected){
                    clazz+=" selected";
                }
                return clazz;
            },

            jumpToLine: function(line) {
                if (!line) {
                    line = 0;
                }
                if (line > 4)
                    line = line - 4;

                var task = function() {
                    if (this.$.listOfLines.items)
                        this.$.listOfLines.scrollToIndex(line);
                    }
                setTimeout(task.bind(this), 100);

            },

            _lineNumber: function(index) {
                return index + 1;
            },

            maybeLoadFile: function(newFile, aftereffect) {
                // console.error("maybeLoadFile:"+this._shouldLoad(newFile));
                if (this._shouldLoad(newFile)) {
                    this._loadedFile = newFile;
                    //XXX: handle errors;
                    this.currentProject.loadFile(newFile.relativePath).then(function(fileContents) {
                        this.set("lines", fileContents.lines);
                        aftereffect();
                    }.bind(this));

                } else {
                    aftereffect();
                }

            },

            _shouldLoad: function(newFile) {
                if (newFile && !newFile.dir) {
                    if (this._loadedFile) {
                        return this._loadedFile.relativePath != newFile.relativePath;
                    } else {
                        return true;
                    }
                }
                return false;
            }
        });
    </script>

</dom-module>
