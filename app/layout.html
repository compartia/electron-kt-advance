<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">

<link rel="import" href="../bower_components/vaadin-split-layout/vaadin-split-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<!-- ///// -->
<link rel="import" href="components/source/source-view.html">
<link rel="import" href="components/common/po-filter-panel.html">
<link rel="import" href="components/treeview/paper-tree.html">
<link rel="import" href="components/treeview/functions-list.html">
<link rel="import" href="components/po_list/po-list.html">

<link rel="import" href="components/stats/kt-stats.html">

<link rel="import" href="components/tf_graph_loader/tf-graph-loader.html">
<link rel="import" href="components/tf_graph_board/tf-graph-board.html">

<dom-module id="kt-layout">
    <template>

        <template is="dom-if" if="[[_isNotComplete(progress)]]">
            <div id="progress-bar">
                <paper-progress value="[[progress.value]]" style="width:100%"></paper-progress>
            </div>
            <div id="progress-msg" class="toast" class$="[[_getToastClass(progress)]]">[[progress.msg]]</div>
        </template>

        <vaadin-split-layout class="splitter-1">

            <div style="width:15%; position: relative; overflow:none">
                <paper-header-panel mode="waterfall" class="panel-files">
                    <paper-toolbar>
                        <paper-icon-button icon="menu" on-tap="openProject"></paper-icon-button>
                    </paper-toolbar>
                    <paper-tree id="treeview" selected-file="{{filter.file}}" statistics="[[statistics]]"></paper-tree>
                </paper-header-panel>
            </div>

            <div style="width:85%">

                <vaadin-split-layout class="splitter-2">

                    <paper-header-panel style$="[[_computeFunctionListStyle(filter.file)]]" mode="waterfall" class="panel-functions">
                        <paper-toolbar></paper-toolbar>
                        <functions-list id="functions" selected-file="[[filter.file]]" statistics="[[statistics]]" selected-function="{{filter.cfunction}}" project="[[currentProject]]"></functions-list>
                    </paper-header-panel>

                    <paper-header-panel style="width:80%" mode="standard">

                        <paper-toolbar id="toolbar">

                            <paper-tabs selected="{{modeIndex}}" class="tabs" id="tabs" scrollable fit-container style="width: 80%;">
                                <template is="dom-repeat" items="[[tabs]]">
                                    <template is="dom-if" if="[[_isTabEnabled(item)]]">
                                        <paper-tab data-mode="[[item]]">[[item]]</paper-tab>
                                    </template>
                                </template>
                            </paper-tabs>

                        </paper-toolbar>

                        <po-filter-panel statistics="[[statistics]]" filter="{{filter}}" project="[[currentProject]]"></po-filter-panel>

                        <tf-graph-loader
                            id="loader"
                            filtered-proof-obligations="[[filteredProofObligations]]"
                            out-graph-hierarchy="{{graphHierarchy}}"
                            out-graph="{{graph}}"
                            filter="{{filter}}"
                            progress="{{progress}}"
                            current-project="[[currentProject]]"
                            out-hierarchy-params="{{_hierarchyParams}}"></tf-graph-loader>

                        <iron-pages class="content fit" id="contents" selected="{{modeIndex}}">

                            <kt-stats progress="{{progress}}" statistics="[[statistics]]" filter="{{filter}}"></kt-stats>

                            <source-view id="sourceview" current-project="[[currentProject]]" statistics="[[statistics]]"></source-view>

                            <po-list filtered-proof-obligations="[[filteredProofObligations]]" linktosource showgroups></po-list>


                            <div>assumptions</div>

                            <tf-graph-board
                                id="graphboard"
                                color-by="[[colorBy]]"
                                color-by-params="{{colorByParams}}"
                                devices-for-stats="[[_devicesForStats]]"
                                graph-hierarchy="[[graphHierarchy]]"
                                graph="[[graph]]"
                                progress="{{progress}}"
                                hierarchy-params="[[_hierarchyParams]]"
                                render-hierarchy="{{_renderHierarchy}}"></tf-graph-board>

                        </iron-pages>

                    </paper-header-panel>

                </vaadin-split-layout >

            </div>
        </vaadin-split-layout>

        <style>
            vaadin-split-layout {}

            paper-header-panel.panel-files {
                --paper-header-panel-waterfall-container: {
                    background: var(--kt-side-bg);
                };
            }

            paper-header-panel.panel-functions {
                --paper-header-panel-waterfall-container: {
                    background: var(--kt-side-bg-2);
                };
            }

            paper-progress {
                z-index: 2000;
                position: fixed;
                top: 0;
                width: 100%;
                --paper-progress-height: 4px;
                --paper-progress-active-color: var(--kt-progress);
            }

            :host {
                height: 100%;
                display: block;
                background-color: var(--kt-grey-80);

                --paper-tabs-selection-bar-color: var(--kt-violet);
                --paper-tab-ink: var(--kt-text-color);
                --paper-toolbar-color: var(--kt-text-color, black);
            }

            #toolbar {
                background-color: var(--kt-grey-lighter);
                -webkit-font-smoothing: antialiased;
            }

            .toolbar-title {
                font-size: 20px;
                margin-left: 10px;
                text-rendering: optimizeLegibility;
                letter-spacing: -0.025em;
                font-weight: 500;
                flex-grow: 2;
                display: var(--tb-toolbar-title-display, block);
            }

            .tabs {
                flex-grow: 1;
                text-transform: uppercase;
                height: 100%;
            }

            paper-tabs {}

            .splitter-1,
            .splitter-2 {
                --vaadin-split-layout-splitter: {
                    min-width: 1px;
                    min-height: 1px;
                    border: solid 4px none;
                    background-clip: content-box;
                }

            }
            .splitter-1 {
                --vaadin-split-layout-splitter: {
                    background: var(--paper-tree-selected-background-color);
                    fill: var(--paper-tree-selected-background-color);
                };

                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }

            .splitter-2 {
                --vaadin-split-layout-splitter: {
                    fill: var(--kt-main-bg);
                    background: var(--kt-main-bg);
                };

                height: 100%;
            }

            .global-actions {
                flex-grow: 2;
                display: inline-flex;
                /* Ensure that icons stay aligned */
                justify-content: flex-end;
                text-align: right;
                color: var(--kt-text-color);
            }

            .global-actions a {
                color: var(--kt-text-color);
            }

            #toolbar-content {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            #content {
                height: 100%;
            }

            [disabled] {
                opacity: 0.2;
                color: var(--kt-text-color);
            }

        </style>
    </template>
    <script>
        Polymer({
            is: "kt-layout",
            properties: {

                // Which tab is selected (stats, graph,  etc).
                mode: {
                    type: String,
                    computed: '_getModeFromIndex(modeIndex)',
                    notify: true
                },

                _renderHierarchy: Object,

                tabs: {
                    type: Array,
                    readOnly: true,
                    value: kt.Globals.TABS
                },

                progress: {
                    type: Object,
                    notify: true
                },

                currentProject: {
                    type: Object,
                    notify: true
                },

                filteredProofObligations: {
                    type: Object,
                    notify: true
                },

                filter: {
                    type: Object,
                    value: kt.Globals.PO_FILTER,
                    notify: true
                },

                statistics: {
                    type: Object,
                    notify: true
                },

                disabledTabs: String
            },

            listeners: {
                "project-loaded": "_onProjectLoaded",
                "jump-to-src": "_onJumpToSrc"
            },

            observers: ['filterChanged(filter.*)'],

            _onJumpToSrc: function(event) {
                var po = event.detail;
                this.modeIndex = 1;

                this.set("filter.file", po.cfunction.fileInfo);
                //this.set("filter.cfunction", po.cfunction);
                this.set("filter.line", po.location.line);

                var aftereffect = () => {
                    this.$.sourceview.jumpToLine(po.location.line)
                };
                sourceview.maybeLoadFile(this.filter.file, aftereffect.bind(this));
            },

            filterChanged: function(event) {
                if (this.currentProject) {
                    console.info("filterChanged: " + event);
                    console.info(event);

                    if (!this.pendingFilterChanges) {
                        var task = function() {
                            this._applyFilterAsync(this.currentProject, this.filter);
                        }
                        setTimeout(task.bind(this), 100);
                    }

                    this.pendingFilterChanges = true;
                }

            },

            _applyFilterAsync: function(project, filter) {
                console.info("applying filter..");
                this.pendingFilterChanges = false;

                if (project) {

                    project.onFilterChanged(filter);
                    this.set("statistics", project.buildStatistics());
                    this.set("filteredProofObligations", project.filteredProofObligations);

                    var sourceview = this.$.sourceview;
                    var aftereffect = () => {
                        sourceview.jumpToLine(this.filter.line)
                    };

                    sourceview.maybeLoadFile(filter.file, aftereffect.bind(this));
                }
            },

            _onProjectLoaded(event) {
                console.info("_onProjectLoaded: " + event);
                kt.treeview.build(this.$$("#treeview"), this.currentProject);
                this.set("filter.predicates", new kt.util.StringSet(this.currentProject.allPredicates));
                this.set("filter.levels", new kt.util.StringSet(kt.model.PoLevels));
                this.set("filter.states", new kt.util.StringSet(kt.model.PoStatesArr));
                this.set("filter.dischargeTypes", new kt.util.StringSet(kt.model.PoDischargeTypesArr));
                this.notifyPath("currentProject.allPredicates");
            },

            _isNotComplete: function(progress) {
                return progress.value < 100;
            },

            _isTabEnabled: function(tab) {
                if (this.disabledTabs != null && this.disabledTabs.split(',').indexOf(tab) >= 0) {
                    return false;
                }
                return true;
            },

            _getModeFromIndex: function(modeIndex) {
                var mode = this.tabs[modeIndex];
                return mode;
            },

            _modeIsSource: function(mode) {
                return mode === "source";
            },

            _modeIsPo: function(mode) {
                return mode === "proof obligations";
            },

            _modeIsSummary: function(mode) {
                return mode === "summary";
            },

            _modeIsGraphs: function(mode) {
                return mode === "graphs";
            },

            selectedDashboard: function() {
                var dashboard = this.$$("#" + this.mode);
                if (dashboard == null) {
                    throw new Error(`Unable to find dashboard for mode: ${this.mode}`);
                }
                return dashboard;
            },

            _getToastClass: function(_progress) {
                var result = 'toast';
                if (_progress.error) {
                    result += ' error';
                }
                return result;
            },

            openProject: function() {
                var _self = this;
                _self.set('progress', {
                    value: 0,
                    msg: ''
                });

                var tracker = tf.graph.util.getTracker(this);

                var newProject = kt.Globals.openNewProject(tracker);

                if (newProject) {
                    _self.set("currentProject", newProject);
                    _self.set('modeIndex', 0);
                    _self.set('progress', {
                        value: 0,
                        msg: ''
                    });

                } else {
                    _self.set('progress', {
                        value: 100,
                        msg: ''
                    });
                    console.log("cancelled");
                }

            },

            _computeFunctionListStyle: function(filterFile) {
                if (this.$.functions.isEmpty()) {
                    return "display:none";
                } else {
                    return "width:20%";
                }
            },

            ready: function() {
                this.openProject();
            }
        });
    </script>

</dom-module>
